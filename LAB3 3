/*
 * Exercise 3 – Sleep mode (Timer1 wake-up, Timer0 LED control)
 * MCU: ATmega328P  (Arduino Uno)
 *
 * Behavior:
 *  - MCU sleeps in idle mode
 *  - Timer1 interrupt every 1 s wakes MCU
 *  - On wake: LED ON for 0.1 s, timed by Timer0 (CTC mode)
 *  - After LED OFF, MCU goes back to sleep
 */

#include <avr/io.h>
#include <avr/interrupt.h>
#include <avr/sleep.h>
#include <avr/power.h>

#define LED_PIN PB5   // Onboard LED (digital 13)
volatile uint8_t led_on = 0;  // flag for LED state

// ---------------- Timer1: 1 second wake-up ----------------
void timer1_init(void)
{
    TCCR1A = 0;
    TCCR1B = 0;
    TCCR1B |= (1 << WGM12);             // CTC mode
    TCCR1B |= (1 << CS12) | (1 << CS10); // Prescaler = 1024
    OCR1A = 15624;                      // Compare at 1 Hz
    TIMSK1 |= (1 << OCIE1A);            // Enable compare interrupt
}

// ---------------- Timer0: 0.1 second LED timing ----------------
void timer0_init(void)
{
    TCCR0A = 0;
    TCCR0B = 0;
    TCCR0A |= (1 << WGM01);             // CTC mode
    TCCR0B |= (1 << CS02) | (1 << CS00); // Prescaler = 1024
    OCR0A = 1562;                       // 16MHz / (1024 * 1562) ≈ 0.1 s
    TIMSK0 |= (1 << OCIE0A);            // Enable compare interrupt
}

// ---------------- Interrupts ----------------

// Timer1 Compare Match A → wakes MCU every 1 second
ISR(TIMER1_COMPA_vect)
{
    led_on = 1;                    // Flag to turn on LED
    PORTB |= (1 << LED_PIN);       // LED ON
    TCNT0 = 0;                     // Reset Timer0 count
    TCCR0B |= (1 << CS02) | (1 << CS00); // Start Timer0
}

// Timer0 Compare Match A → LED OFF after 0.1 s
ISR(TIMER0_COMPA_vect)
{
    PORTB &= ~(1 << LED_PIN);      // LED OFF
    TCCR0B = 0;                    // Stop Timer0
    led_on = 0;                    // Clear flag
}

int main(void)
{
    // --- Setup ---
    DDRB |= (1 << LED_PIN);        // PB5 output

    // Disable unused peripherals for lower power
    power_adc_disable();
    power_spi_disable();
    power_twi_disable();

    timer1_init();                 // Initialize 1 s timer
    timer0_init();                 // Initialize 0.1 s timer (stopped initially)

    sei();                         // Enable global interrupts

    // --- Main loop ---
    while (1)
    {
        // Sleep when LED is off (idle mode keeps timers running)
        if (!led_on)
        {
            set_sleep_mode(SLEEP_MODE_IDLE);
            sleep_enable();
            sleep_cpu();           // Sleep until interrupt
            sleep_disable();
        }
    }
}
